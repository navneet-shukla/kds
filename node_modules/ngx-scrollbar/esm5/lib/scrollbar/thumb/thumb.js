/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Input, Output } from '@angular/core';
import { animationFrameScheduler, of, fromEvent, Subject } from 'rxjs';
import { distinctUntilChanged, map, mergeMap, pluck, takeUntil, tap } from 'rxjs/operators';
import { enableSelection, preventSelection, stopPropagation } from '../common';
import { TrackAdapter } from '../track/track';
/**
 * @abstract
 */
var ThumbAdapter = /** @class */ (function () {
    function ThumbAdapter(cmp, thumbElement, document) {
        this.cmp = cmp;
        this.thumbElement = thumbElement;
        this.document = document;
        // Stream that emits dragging state
        this._dragging = new Subject();
        this.dragging = this._dragging.pipe(distinctUntilChanged());
    }
    Object.defineProperty(ThumbAdapter.prototype, "trackMax", {
        get: /**
         * @return {?}
         */
        function () {
            return this.track.size - this.size;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ThumbAdapter.prototype, "clientRect", {
        // Get thumb client rect
        get: 
        // Get thumb client rect
        /**
         * @return {?}
         */
        function () {
            return this.thumbElement.getBoundingClientRect();
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ThumbAdapter.prototype, "clicked", {
        // Stream that emits when scrollbar thumb is clicked
        get: 
        // Stream that emits when scrollbar thumb is clicked
        /**
         * @return {?}
         */
        function () {
            return fromEvent(this.thumbElement, 'mousedown', { passive: true }).pipe(stopPropagation());
        },
        enumerable: true,
        configurable: true
    });
    // Calculate and update thumb position and size
    // Calculate and update thumb position and size
    /**
     * @return {?}
     */
    ThumbAdapter.prototype.update = 
    // Calculate and update thumb position and size
    /**
     * @return {?}
     */
    function () {
        var _this = this;
        /** @type {?} */
        var size = calculateThumbSize(this.track.size, this.viewportScrollSize, (/** @type {?} */ (this.cmp.minThumbSize)));
        /** @type {?} */
        var position = calculateThumbPosition(this.viewportScrollOffset, this.viewportScrollMax, this.trackMax);
        animationFrameScheduler.schedule((/**
         * @return {?}
         */
        function () { return _this.updateStyles(_this.handleDirection(position, _this.trackMax), size); }));
    };
    /**
     * Stream that emits the 'scrollTo' position when a scrollbar thumb element is dragged
     * This function is called by thumb drag event using viewport or scrollbar pointer events
     */
    /**
     * Stream that emits the 'scrollTo' position when a scrollbar thumb element is dragged
     * This function is called by thumb drag event using viewport or scrollbar pointer events
     * @param {?} event
     * @return {?}
     */
    ThumbAdapter.prototype.dragged = /**
     * Stream that emits the 'scrollTo' position when a scrollbar thumb element is dragged
     * This function is called by thumb drag event using viewport or scrollbar pointer events
     * @param {?} event
     * @return {?}
     */
    function (event) {
        var _this = this;
        /** @type {?} */
        var trackMaxStart;
        /** @type {?} */
        var scrollMaxStart;
        /** @type {?} */
        var dragStart = of(event).pipe(preventSelection(this.document), tap((/**
         * @return {?}
         */
        function () {
            // Capture scrollMax and trackMax once
            trackMaxStart = _this.trackMax;
            scrollMaxStart = _this.viewportScrollMax;
            _this.setDragging(true);
        })));
        /** @type {?} */
        var dragging = fromEvent(this.document, 'mousemove', { capture: true, passive: true }).pipe(stopPropagation());
        /** @type {?} */
        var dragEnd = fromEvent(this.document, 'mouseup', { capture: true }).pipe(stopPropagation(), enableSelection(this.document), tap((/**
         * @return {?}
         */
        function () { return _this.setDragging(false); })));
        return dragStart.pipe(pluck(this.pageProperty), map((/**
         * @param {?} pageOffset
         * @return {?}
         */
        function (pageOffset) { return pageOffset - _this.dragStartOffset; })), mergeMap((/**
         * @param {?} mouseDownOffset
         * @return {?}
         */
        function (mouseDownOffset) { return dragging.pipe(pluck(_this.clientProperty), 
        // Calculate how far the pointer is from the top/left of the scrollbar (minus the dragOffset).
        map((/**
         * @param {?} mouseOffset
         * @return {?}
         */
        function (mouseOffset) { return mouseOffset - _this.track.offset; })), map((/**
         * @param {?} offset
         * @return {?}
         */
        function (offset) { return scrollMaxStart * (offset - mouseDownOffset) / trackMaxStart; })), map((/**
         * @param {?} position
         * @return {?}
         */
        function (position) { return _this.handleDrag(position, scrollMaxStart); })), tap((/**
         * @param {?} position
         * @return {?}
         */
        function (position) { return _this.scrollTo(position); })), takeUntil(dragEnd)); })));
    };
    ThumbAdapter.propDecorators = {
        track: [{ type: Input }],
        dragging: [{ type: Output }]
    };
    return ThumbAdapter;
}());
export { ThumbAdapter };
if (false) {
    /** @type {?} */
    ThumbAdapter.prototype.track;
    /**
     * @type {?}
     * @private
     */
    ThumbAdapter.prototype._dragging;
    /** @type {?} */
    ThumbAdapter.prototype.dragging;
    /**
     * @type {?}
     * @protected
     */
    ThumbAdapter.prototype.cmp;
    /**
     * @type {?}
     * @protected
     */
    ThumbAdapter.prototype.thumbElement;
    /**
     * @type {?}
     * @protected
     */
    ThumbAdapter.prototype.document;
    /**
     * @abstract
     * @protected
     * @return {?}
     */
    ThumbAdapter.prototype.pageProperty = function () { };
    /**
     * @abstract
     * @protected
     * @return {?}
     */
    ThumbAdapter.prototype.clientProperty = function () { };
    /**
     * @abstract
     * @return {?}
     */
    ThumbAdapter.prototype.dragStartOffset = function () { };
    /**
     * @abstract
     * @return {?}
     */
    ThumbAdapter.prototype.size = function () { };
    /**
     * @abstract
     * @protected
     * @return {?}
     */
    ThumbAdapter.prototype.viewportScrollSize = function () { };
    /**
     * @abstract
     * @protected
     * @return {?}
     */
    ThumbAdapter.prototype.viewportScrollOffset = function () { };
    /**
     * @abstract
     * @return {?}
     */
    ThumbAdapter.prototype.viewportScrollMax = function () { };
    /**
     * @abstract
     * @protected
     * @param {?} value
     * @return {?}
     */
    ThumbAdapter.prototype.setDragging = function (value) { };
    /**
     * @abstract
     * @protected
     * @param {?} position
     * @return {?}
     */
    ThumbAdapter.prototype.scrollTo = function (position) { };
    /**
     * @abstract
     * @protected
     * @param {?} position
     * @param {?} size
     * @return {?}
     */
    ThumbAdapter.prototype.updateStyles = function (position, size) { };
    /**
     * @abstract
     * @protected
     * @param {?} position
     * @param {?=} scrollMax
     * @return {?}
     */
    ThumbAdapter.prototype.handleDrag = function (position, scrollMax) { };
    /**
     * @abstract
     * @protected
     * @param {?} position
     * @param {?=} scrollMax
     * @return {?}
     */
    ThumbAdapter.prototype.handleDirection = function (position, scrollMax) { };
}
/**
 * Calculate scrollbar thumb size
 * @param {?} trackSize
 * @param {?} contentSize
 * @param {?} minThumbSize
 * @return {?}
 */
function calculateThumbSize(trackSize, contentSize, minThumbSize) {
    /** @type {?} */
    var scrollbarRatio = trackSize / contentSize;
    /** @type {?} */
    var thumbSize = scrollbarRatio * trackSize;
    return Math.max(~~thumbSize, minThumbSize);
}
/**
 * Calculate scrollbar thumb position
 * @param {?} scrollPosition
 * @param {?} scrollMax
 * @param {?} trackMax
 * @return {?}
 */
function calculateThumbPosition(scrollPosition, scrollMax, trackMax) {
    return scrollPosition * trackMax / scrollMax;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGh1bWIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZ3gtc2Nyb2xsYmFyLyIsInNvdXJjZXMiOlsibGliL3Njcm9sbGJhci90aHVtYi90aHVtYi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDOUMsT0FBTyxFQUFFLHVCQUF1QixFQUFFLEVBQUUsRUFBRSxTQUFTLEVBQWMsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ25GLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxHQUFHLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDNUYsT0FBTyxFQUFFLGVBQWUsRUFBRSxnQkFBZ0IsRUFBRSxlQUFlLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFFL0UsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGdCQUFnQixDQUFDOzs7O0FBRTlDO0lBdUNFLHNCQUFnQyxHQUFnQixFQUNoQixZQUF5QixFQUN6QixRQUFhO1FBRmIsUUFBRyxHQUFILEdBQUcsQ0FBYTtRQUNoQixpQkFBWSxHQUFaLFlBQVksQ0FBYTtRQUN6QixhQUFRLEdBQVIsUUFBUSxDQUFLOztRQXBDckMsY0FBUyxHQUFHLElBQUksT0FBTyxFQUFXLENBQUM7UUFDakMsYUFBUSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLG9CQUFvQixFQUFFLENBQUMsQ0FBQztJQW9DakUsQ0FBQztJQWpCRCxzQkFBSSxrQ0FBUTs7OztRQUFaO1lBQ0UsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDO1FBQ3JDLENBQUM7OztPQUFBO0lBR0Qsc0JBQUksb0NBQVU7UUFEZCx3QkFBd0I7Ozs7OztRQUN4QjtZQUNFLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO1FB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QUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbnB1dCwgT3V0cHV0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IGFuaW1hdGlvbkZyYW1lU2NoZWR1bGVyLCBvZiwgZnJvbUV2ZW50LCBPYnNlcnZhYmxlLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IGRpc3RpbmN0VW50aWxDaGFuZ2VkLCBtYXAsIG1lcmdlTWFwLCBwbHVjaywgdGFrZVVudGlsLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IGVuYWJsZVNlbGVjdGlvbiwgcHJldmVudFNlbGVjdGlvbiwgc3RvcFByb3BhZ2F0aW9uIH0gZnJvbSAnLi4vY29tbW9uJztcclxuaW1wb3J0IHsgTmdTY3JvbGxiYXIgfSBmcm9tICcuLi8uLi9uZy1zY3JvbGxiYXInO1xyXG5pbXBvcnQgeyBUcmFja0FkYXB0ZXIgfSBmcm9tICcuLi90cmFjay90cmFjayc7XHJcblxyXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgVGh1bWJBZGFwdGVyIHtcclxuXHJcbiAgQElucHV0KCkgdHJhY2s6IFRyYWNrQWRhcHRlcjtcclxuXHJcbiAgLy8gU3RyZWFtIHRoYXQgZW1pdHMgZHJhZ2dpbmcgc3RhdGVcclxuICBwcml2YXRlIF9kcmFnZ2luZyA9IG5ldyBTdWJqZWN0PGJvb2xlYW4+KCk7XHJcbiAgQE91dHB1dCgpIGRyYWdnaW5nID0gdGhpcy5fZHJhZ2dpbmcucGlwZShkaXN0aW5jdFVudGlsQ2hhbmdlZCgpKTtcclxuXHJcbiAgLy8gUmV0dXJucyBlaXRoZXIgJ3BhZ2VYJyBvciAncGFnZVknIGFjY29yZGluZyB0byBzY3JvbGxiYXIgYXhpc1xyXG4gIHByb3RlY3RlZCBhYnN0cmFjdCBnZXQgcGFnZVByb3BlcnR5KCk6IHN0cmluZztcclxuXHJcbiAgLy8gUmV0dXJucyBlaXRoZXIgJ2NsaWVudEhlaWdodCcgb3IgJ2NsaWVudFdpZHRoJyBhY2NvcmRpbmcgdG8gc2Nyb2xsYmFyIGF4aXNcclxuICBwcm90ZWN0ZWQgYWJzdHJhY3QgZ2V0IGNsaWVudFByb3BlcnR5KCk6IHN0cmluZztcclxuXHJcbiAgYWJzdHJhY3QgZ2V0IGRyYWdTdGFydE9mZnNldCgpOiBudW1iZXI7XHJcblxyXG4gIC8vIFJldHVybnMgdGh1bWIgc2l6ZSwgY2xpZW50SGVpZ2h0IG9yIGNsaWVudFdpZHRoXHJcbiAgYWJzdHJhY3QgZ2V0IHNpemUoKTogbnVtYmVyO1xyXG5cclxuICBwcm90ZWN0ZWQgYWJzdHJhY3QgZ2V0IHZpZXdwb3J0U2Nyb2xsU2l6ZSgpOiBudW1iZXI7XHJcblxyXG4gIHByb3RlY3RlZCBhYnN0cmFjdCBnZXQgdmlld3BvcnRTY3JvbGxPZmZzZXQoKTogbnVtYmVyO1xyXG5cclxuICBhYnN0cmFjdCBnZXQgdmlld3BvcnRTY3JvbGxNYXgoKTogbnVtYmVyO1xyXG5cclxuICBnZXQgdHJhY2tNYXgoKTogbnVtYmVyIHtcclxuICAgIHJldHVybiB0aGlzLnRyYWNrLnNpemUgLSB0aGlzLnNpemU7XHJcbiAgfVxyXG5cclxuICAvLyBHZXQgdGh1bWIgY2xpZW50IHJlY3RcclxuICBnZXQgY2xpZW50UmVjdCgpOiBDbGllbnRSZWN0IHtcclxuICAgIHJldHVybiB0aGlzLnRodW1iRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcclxuICB9XHJcblxyXG4gIC8vIFN0cmVhbSB0aGF0IGVtaXRzIHdoZW4gc2Nyb2xsYmFyIHRodW1iIGlzIGNsaWNrZWRcclxuICBnZXQgY2xpY2tlZCgpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgcmV0dXJuIGZyb21FdmVudCh0aGlzLnRodW1iRWxlbWVudCwgJ21vdXNlZG93bicsIHsgcGFzc2l2ZTogdHJ1ZSB9KS5waXBlKHN0b3BQcm9wYWdhdGlvbigpKTtcclxuICB9XHJcblxyXG4gIHByb3RlY3RlZCBjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgY21wOiBOZ1Njcm9sbGJhcixcclxuICAgICAgICAgICAgICAgICAgICAgICAgcHJvdGVjdGVkIHRodW1iRWxlbWVudDogSFRNTEVsZW1lbnQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb3RlY3RlZCBkb2N1bWVudDogYW55KSB7XHJcbiAgfVxyXG5cclxuICAvLyBDYWxjdWxhdGUgYW5kIHVwZGF0ZSB0aHVtYiBwb3NpdGlvbiBhbmQgc2l6ZVxyXG4gIHVwZGF0ZSgpIHtcclxuICAgIGNvbnN0IHNpemUgPSBjYWxjdWxhdGVUaHVtYlNpemUodGhpcy50cmFjay5zaXplLCB0aGlzLnZpZXdwb3J0U2Nyb2xsU2l6ZSwgdGhpcy5jbXAubWluVGh1bWJTaXplISk7XHJcbiAgICBjb25zdCBwb3NpdGlvbiA9IGNhbGN1bGF0ZVRodW1iUG9zaXRpb24odGhpcy52aWV3cG9ydFNjcm9sbE9mZnNldCwgdGhpcy52aWV3cG9ydFNjcm9sbE1heCwgdGhpcy50cmFja01heCk7XHJcbiAgICBhbmltYXRpb25GcmFtZVNjaGVkdWxlci5zY2hlZHVsZSgoKSA9PiB0aGlzLnVwZGF0ZVN0eWxlcyh0aGlzLmhhbmRsZURpcmVjdGlvbihwb3NpdGlvbiwgdGhpcy50cmFja01heCksIHNpemUpKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFN0cmVhbSB0aGF0IGVtaXRzIHRoZSAnc2Nyb2xsVG8nIHBvc2l0aW9uIHdoZW4gYSBzY3JvbGxiYXIgdGh1bWIgZWxlbWVudCBpcyBkcmFnZ2VkXHJcbiAgICogVGhpcyBmdW5jdGlvbiBpcyBjYWxsZWQgYnkgdGh1bWIgZHJhZyBldmVudCB1c2luZyB2aWV3cG9ydCBvciBzY3JvbGxiYXIgcG9pbnRlciBldmVudHNcclxuICAgKi9cclxuICBkcmFnZ2VkKGV2ZW50OiBhbnkpOiBPYnNlcnZhYmxlPG51bWJlcj4ge1xyXG4gICAgbGV0IHRyYWNrTWF4U3RhcnQ6IG51bWJlcjtcclxuICAgIGxldCBzY3JvbGxNYXhTdGFydDogbnVtYmVyO1xyXG5cclxuICAgIGNvbnN0IGRyYWdTdGFydCA9IG9mKGV2ZW50KS5waXBlKFxyXG4gICAgICBwcmV2ZW50U2VsZWN0aW9uKHRoaXMuZG9jdW1lbnQpLFxyXG4gICAgICB0YXAoKCkgPT4ge1xyXG4gICAgICAgIC8vIENhcHR1cmUgc2Nyb2xsTWF4IGFuZCB0cmFja01heCBvbmNlXHJcbiAgICAgICAgdHJhY2tNYXhTdGFydCA9IHRoaXMudHJhY2tNYXg7XHJcbiAgICAgICAgc2Nyb2xsTWF4U3RhcnQgPSB0aGlzLnZpZXdwb3J0U2Nyb2xsTWF4O1xyXG4gICAgICAgIHRoaXMuc2V0RHJhZ2dpbmcodHJ1ZSk7XHJcbiAgICAgIH0pLFxyXG4gICAgKTtcclxuXHJcbiAgICBjb25zdCBkcmFnZ2luZyA9IGZyb21FdmVudCh0aGlzLmRvY3VtZW50LCAnbW91c2Vtb3ZlJywgeyBjYXB0dXJlOiB0cnVlLCBwYXNzaXZlOiB0cnVlIH0pLnBpcGUoc3RvcFByb3BhZ2F0aW9uKCkpO1xyXG5cclxuICAgIGNvbnN0IGRyYWdFbmQgPSBmcm9tRXZlbnQodGhpcy5kb2N1bWVudCwgJ21vdXNldXAnLCB7IGNhcHR1cmU6IHRydWUgfSkucGlwZShcclxuICAgICAgc3RvcFByb3BhZ2F0aW9uKCksXHJcbiAgICAgIGVuYWJsZVNlbGVjdGlvbih0aGlzLmRvY3VtZW50KSxcclxuICAgICAgdGFwKCgpID0+IHRoaXMuc2V0RHJhZ2dpbmcoZmFsc2UpKVxyXG4gICAgKTtcclxuXHJcbiAgICByZXR1cm4gZHJhZ1N0YXJ0LnBpcGUoXHJcbiAgICAgIHBsdWNrKHRoaXMucGFnZVByb3BlcnR5KSxcclxuICAgICAgbWFwKChwYWdlT2Zmc2V0OiBudW1iZXIpID0+IHBhZ2VPZmZzZXQgLSB0aGlzLmRyYWdTdGFydE9mZnNldCksXHJcbiAgICAgIG1lcmdlTWFwKChtb3VzZURvd25PZmZzZXQ6IG51bWJlcikgPT4gZHJhZ2dpbmcucGlwZShcclxuICAgICAgICBwbHVjayh0aGlzLmNsaWVudFByb3BlcnR5KSxcclxuICAgICAgICAvLyBDYWxjdWxhdGUgaG93IGZhciB0aGUgcG9pbnRlciBpcyBmcm9tIHRoZSB0b3AvbGVmdCBvZiB0aGUgc2Nyb2xsYmFyIChtaW51cyB0aGUgZHJhZ09mZnNldCkuXHJcbiAgICAgICAgbWFwKChtb3VzZU9mZnNldDogbnVtYmVyKSA9PiBtb3VzZU9mZnNldCAtIHRoaXMudHJhY2sub2Zmc2V0KSxcclxuICAgICAgICBtYXAoKG9mZnNldDogbnVtYmVyKSA9PiBzY3JvbGxNYXhTdGFydCAqIChvZmZzZXQgLSBtb3VzZURvd25PZmZzZXQpIC8gdHJhY2tNYXhTdGFydCksXHJcbiAgICAgICAgbWFwKChwb3NpdGlvbjogbnVtYmVyKSA9PiB0aGlzLmhhbmRsZURyYWcocG9zaXRpb24sIHNjcm9sbE1heFN0YXJ0KSksXHJcbiAgICAgICAgdGFwKChwb3NpdGlvbjogbnVtYmVyKSA9PiB0aGlzLnNjcm9sbFRvKHBvc2l0aW9uKSksXHJcbiAgICAgICAgdGFrZVVudGlsKGRyYWdFbmQpXHJcbiAgICAgICkpXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLy8gU2V0IGRyYWdnaW5nIHN0YXRlXHJcbiAgcHJvdGVjdGVkIGFic3RyYWN0IHNldERyYWdnaW5nKHZhbHVlOiBib29sZWFuKTogdm9pZDtcclxuXHJcbiAgLy8gU2Nyb2xsIHZpZXdwb3J0IGluc3RhbnRseVxyXG4gIHByb3RlY3RlZCBhYnN0cmFjdCBzY3JvbGxUbyhwb3NpdGlvbjogbnVtYmVyKTogdm9pZDtcclxuXHJcbiAgLy8gVXBkYXRlIHRodW1iIGVsZW1lbnQgc2l6ZSBhbmQgcG9zaXRpb25cclxuICBwcm90ZWN0ZWQgYWJzdHJhY3QgdXBkYXRlU3R5bGVzKHBvc2l0aW9uOiBudW1iZXIsIHNpemU6IG51bWJlcik6IHZvaWQ7XHJcblxyXG4gIC8vIEhhbmRsZSBkcmFnZ2luZyBwb3NpdGlvbiAoU3VwcG9ydCBMVFIgYW5kIFJUTCBkaXJlY3Rpb25zIGZvciB0aGUgaG9yaXpvbnRhbCBzY3JvbGxiYXIpXHJcbiAgcHJvdGVjdGVkIGFic3RyYWN0IGhhbmRsZURyYWcocG9zaXRpb246IG51bWJlciwgc2Nyb2xsTWF4PzogbnVtYmVyKTogbnVtYmVyO1xyXG5cclxuICAvLyBIYW5kbGUgc2Nyb2xsaW5nIHBvc2l0aW9uIChTdXBwb3J0IExUUiBhbmQgUlRMIGRpcmVjdGlvbnMgZm9yIHRoZSBob3Jpem9udGFsIHNjcm9sbGJhcilcclxuICBwcm90ZWN0ZWQgYWJzdHJhY3QgaGFuZGxlRGlyZWN0aW9uKHBvc2l0aW9uOiBudW1iZXIsIHNjcm9sbE1heD86IG51bWJlcik6IG51bWJlcjtcclxufVxyXG5cclxuLyoqXHJcbiAqIENhbGN1bGF0ZSBzY3JvbGxiYXIgdGh1bWIgc2l6ZVxyXG4gKi9cclxuZnVuY3Rpb24gY2FsY3VsYXRlVGh1bWJTaXplKHRyYWNrU2l6ZTogbnVtYmVyLCBjb250ZW50U2l6ZTogbnVtYmVyLCBtaW5UaHVtYlNpemU6IG51bWJlcik6IG51bWJlciB7XHJcbiAgY29uc3Qgc2Nyb2xsYmFyUmF0aW8gPSB0cmFja1NpemUgLyBjb250ZW50U2l6ZTtcclxuICBjb25zdCB0aHVtYlNpemUgPSBzY3JvbGxiYXJSYXRpbyAqIHRyYWNrU2l6ZTtcclxuICByZXR1cm4gTWF0aC5tYXgofn50aHVtYlNpemUsIG1pblRodW1iU2l6ZSk7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBDYWxjdWxhdGUgc2Nyb2xsYmFyIHRodW1iIHBvc2l0aW9uXHJcbiAqL1xyXG5mdW5jdGlvbiBjYWxjdWxhdGVUaHVtYlBvc2l0aW9uKHNjcm9sbFBvc2l0aW9uOiBudW1iZXIsIHNjcm9sbE1heDogbnVtYmVyLCB0cmFja01heDogbnVtYmVyKTogbnVtYmVyIHtcclxuICByZXR1cm4gc2Nyb2xsUG9zaXRpb24gKiB0cmFja01heCAvIHNjcm9sbE1heDtcclxufVxyXG4iXX0=