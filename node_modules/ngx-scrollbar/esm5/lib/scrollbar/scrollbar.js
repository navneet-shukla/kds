/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { asyncScheduler, EMPTY, merge, Subject } from 'rxjs';
import { distinctUntilChanged, map, switchMap, takeUntil, tap } from 'rxjs/operators';
import { isWithinBounds } from './common';
/**
 * @abstract
 */
var /**
 * @abstract
 */
Scrollbar = /** @class */ (function () {
    function Scrollbar(cmp, platform, document, zone) {
        this.cmp = cmp;
        this.platform = platform;
        this.document = document;
        this.zone = zone;
        // Stream that emits to unsubscribe from all streams
        this.destroyed = new Subject();
    }
    /**
     * Activate scrollbar pointer events
     */
    /**
     * Activate scrollbar pointer events
     * @private
     * @return {?}
     */
    Scrollbar.prototype.activatePointerEvents = /**
     * Activate scrollbar pointer events
     * @private
     * @return {?}
     */
    function () {
        var _this = this;
        // Stream that emits when scrollbar thumb is dragged
        /** @type {?} */
        var thumbDragEvent = EMPTY;
        // Stream that emits when scrollbar track is clicked
        /** @type {?} */
        var trackClickEvent = EMPTY;
        // Stream that emits when scrollbar track is hovered
        /** @type {?} */
        var trackHoveredEvent = EMPTY;
        // Set the method used for the pointer events option
        if (this.cmp.pointerEventsMethod === 'viewport') {
            // Pointer events using the viewport
            this.viewportTrackClicked = new Subject();
            this.viewportThumbClicked = new Subject();
            // Activate the pointer events of the viewport directive
            this.cmp.viewport.activatePointerEvents(this.destroyed);
            // Set streams
            thumbDragEvent = this.viewportThumbClicked;
            trackClickEvent = this.viewportTrackClicked;
            trackHoveredEvent = this.cmp.viewport.hovered.pipe(
            // Check if track is hovered
            map((/**
             * @param {?} e
             * @return {?}
             */
            function (e) { return isWithinBounds(e, _this.track.clientRect); })), distinctUntilChanged(), 
            // Enable / disable text selection
            tap((/**
             * @param {?} hovered
             * @return {?}
             */
            function (hovered) { return _this.document.onselectstart = hovered ? (/**
             * @return {?}
             */
            function () { return false; }) : null; })));
            this.cmp.viewport.clicked.pipe(tap((/**
             * @param {?} e
             * @return {?}
             */
            function (e) {
                if (e) {
                    if (isWithinBounds(e, _this.thumb.clientRect)) {
                        _this.viewportThumbClicked.next(e);
                    }
                    else if (isWithinBounds(e, _this.track.clientRect)) {
                        _this.cmp.setClicked(true);
                        _this.viewportTrackClicked.next(e);
                    }
                }
                else {
                    _this.cmp.setClicked(false);
                }
            })), takeUntil(this.destroyed)).subscribe();
        }
        else {
            // Pointer events method is using 'scrollbar'
            thumbDragEvent = this.thumb.clicked;
            trackClickEvent = this.track.clicked;
            trackHoveredEvent = this.track.hovered;
        }
        return merge(
        // Activate scrollbar hovered event
        trackHoveredEvent.pipe(tap((/**
         * @param {?} e
         * @return {?}
         */
        function (e) { return _this.setHovered(e); }))), 
        // Activate scrollbar thumb drag event
        thumbDragEvent.pipe(switchMap((/**
         * @param {?} e
         * @return {?}
         */
        function (e) { return _this.thumb.dragged(e); }))), 
        // Activate scrollbar track click event
        trackClickEvent.pipe(switchMap((/**
         * @param {?} e
         * @return {?}
         */
        function (e) { return _this.track.onTrackClicked(e, _this.thumb.size, _this.viewportScrollSize); }))));
    };
    /**
     * @return {?}
     */
    Scrollbar.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        var _this = this;
        this.zone.runOutsideAngular((/**
         * @return {?}
         */
        function () {
            // Activate pointer events on Desktop only
            if (!(_this.platform.IOS || _this.platform.ANDROID) && !_this.cmp.pointerEventsDisabled) {
                _this.activatePointerEvents().pipe(takeUntil(_this.destroyed)).subscribe();
            }
            // Stream that emits when host component is updated
            /** @type {?} */
            var updated = _this.cmp.updated.pipe(tap((/**
             * @return {?}
             */
            function () { return _this.onUpdated(); })));
            // Update scrollbar thumb when viewport is scrolled and when scrollbar component is updated
            merge(_this.cmp.scrolled, updated).pipe(tap((/**
             * @return {?}
             */
            function () { return _this.thumb.update(); })), takeUntil(_this.destroyed)).subscribe();
            // Initialize scrollbar
            asyncScheduler.schedule((/**
             * @return {?}
             */
            function () { return _this.thumb.update(); }), 100);
        }));
    };
    /**
     * @return {?}
     */
    Scrollbar.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
        this.destroyed.next();
        this.destroyed.complete();
        // Clean up viewport streams if used
        if (this.viewportThumbClicked && this.viewportTrackClicked) {
            this.viewportTrackClicked.complete();
            this.viewportThumbClicked.complete();
        }
    };
    return Scrollbar;
}());
/**
 * @abstract
 */
export { Scrollbar };
if (false) {
    /** @type {?} */
    Scrollbar.prototype.thumb;
    /** @type {?} */
    Scrollbar.prototype.track;
    /**
     * @type {?}
     * @protected
     */
    Scrollbar.prototype.destroyed;
    /**
     * Viewport pointer events
     * The following streams are only activated when (pointerEventsMethod === 'viewport')
     * @type {?}
     * @protected
     */
    Scrollbar.prototype.viewportTrackClicked;
    /**
     * @type {?}
     * @protected
     */
    Scrollbar.prototype.viewportThumbClicked;
    /** @type {?} */
    Scrollbar.prototype.cmp;
    /**
     * @type {?}
     * @protected
     */
    Scrollbar.prototype.platform;
    /**
     * @type {?}
     * @protected
     */
    Scrollbar.prototype.document;
    /**
     * @type {?}
     * @protected
     */
    Scrollbar.prototype.zone;
    /**
     * @abstract
     * @protected
     * @return {?}
     */
    Scrollbar.prototype.viewportScrollSize = function () { };
    /**
     * @abstract
     * @protected
     * @param {?} value
     * @return {?}
     */
    Scrollbar.prototype.setHovered = function (value) { };
    /**
     * @abstract
     * @protected
     * @return {?}
     */
    Scrollbar.prototype.onUpdated = function () { };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2Nyb2xsYmFyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmd4LXNjcm9sbGJhci8iLCJzb3VyY2VzIjpbImxpYi9zY3JvbGxiYXIvc2Nyb2xsYmFyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFFQSxPQUFPLEVBQUUsY0FBYyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQWMsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3pFLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUl0RixPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sVUFBVSxDQUFDOzs7O0FBRTFDOzs7O0lBa0JFLG1CQUE2QixHQUFnQixFQUFZLFFBQWtCLEVBQVksUUFBYSxFQUFZLElBQVk7UUFBL0YsUUFBRyxHQUFILEdBQUcsQ0FBYTtRQUFZLGFBQVEsR0FBUixRQUFRLENBQVU7UUFBWSxhQUFRLEdBQVIsUUFBUSxDQUFLO1FBQVksU0FBSSxHQUFKLElBQUksQ0FBUTs7UUFYekcsY0FBUyxHQUFHLElBQUksT0FBTyxFQUFRLENBQUM7SUFZbkQsQ0FBQztJQUVEOztPQUVHOzs7Ozs7SUFDSyx5Q0FBcUI7Ozs7O0lBQTdCO1FBQUEsaUJBMERDOzs7WUF4REssY0FBYyxHQUFvQixLQUFLOzs7WUFFdkMsZUFBZSxHQUFvQixLQUFLOzs7WUFFeEMsaUJBQWlCLEdBQW9CLEtBQUs7UUFFOUMsb0RBQW9EO1FBQ3BELElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsS0FBSyxVQUFVLEVBQUU7WUFDL0Msb0NBQW9DO1lBQ3BDLElBQUksQ0FBQyxvQkFBb0IsR0FBRyxJQUFJLE9BQU8sRUFBTyxDQUFDO1lBQy9DLElBQUksQ0FBQyxvQkFBb0IsR0FBRyxJQUFJLE9BQU8sRUFBTyxDQUFDO1lBRS9DLHdEQUF3RDtZQUN4RCxJQUFJLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxxQkFBcUIs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QUM7WUFDckMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLFFBQVEsRUFBRSxDQUFDO1NBQ3RDO0lBQ0gsQ0FBQztJQUtILGdCQUFDO0FBQUQsQ0FBQyxBQXZIRCxJQXVIQzs7Ozs7OztJQXBIQywwQkFBNkI7O0lBRTdCLDBCQUE2Qjs7Ozs7SUFFN0IsOEJBQW1EOzs7Ozs7O0lBTW5ELHlDQUE4Qzs7Ozs7SUFDOUMseUNBQThDOztJQUl4Qix3QkFBdUI7Ozs7O0lBQUUsNkJBQTRCOzs7OztJQUFFLDZCQUF1Qjs7Ozs7SUFBRSx5QkFBc0I7Ozs7OztJQUY1SCx5REFBb0Q7Ozs7Ozs7SUFvR3BELHNEQUFvRDs7Ozs7O0lBRXBELGdEQUFxQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE9uRGVzdHJveSwgT25Jbml0LCBOZ1pvbmUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgUGxhdGZvcm0gfSBmcm9tICdAYW5ndWxhci9jZGsvcGxhdGZvcm0nO1xyXG5pbXBvcnQgeyBhc3luY1NjaGVkdWxlciwgRU1QVFksIG1lcmdlLCBPYnNlcnZhYmxlLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IGRpc3RpbmN0VW50aWxDaGFuZ2VkLCBtYXAsIHN3aXRjaE1hcCwgdGFrZVVudGlsLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IE5nU2Nyb2xsYmFyIH0gZnJvbSAnLi4vbmctc2Nyb2xsYmFyJztcclxuaW1wb3J0IHsgVGh1bWJBZGFwdGVyIH0gZnJvbSAnLi90aHVtYi90aHVtYic7XHJcbmltcG9ydCB7IFRyYWNrQWRhcHRlciB9IGZyb20gJy4vdHJhY2svdHJhY2snO1xyXG5pbXBvcnQgeyBpc1dpdGhpbkJvdW5kcyB9IGZyb20gJy4vY29tbW9uJztcclxuXHJcbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBTY3JvbGxiYXIgaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveSB7XHJcblxyXG4gIC8vIFRodW1iIGRpcmVjdGl2ZSByZWZlcmVuY2VcclxuICByZWFkb25seSB0aHVtYjogVGh1bWJBZGFwdGVyO1xyXG4gIC8vIFRyYWNrIGRpcmVjdGl2ZSByZWZlcmVuY2VcclxuICByZWFkb25seSB0cmFjazogVHJhY2tBZGFwdGVyO1xyXG4gIC8vIFN0cmVhbSB0aGF0IGVtaXRzIHRvIHVuc3Vic2NyaWJlIGZyb20gYWxsIHN0cmVhbXNcclxuICBwcm90ZWN0ZWQgcmVhZG9ubHkgZGVzdHJveWVkID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcclxuXHJcbiAgLyoqXHJcbiAgICogVmlld3BvcnQgcG9pbnRlciBldmVudHNcclxuICAgKiBUaGUgZm9sbG93aW5nIHN0cmVhbXMgYXJlIG9ubHkgYWN0aXZhdGVkIHdoZW4gKHBvaW50ZXJFdmVudHNNZXRob2QgPT09ICd2aWV3cG9ydCcpXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIHZpZXdwb3J0VHJhY2tDbGlja2VkITogU3ViamVjdDxhbnk+O1xyXG4gIHByb3RlY3RlZCB2aWV3cG9ydFRodW1iQ2xpY2tlZCE6IFN1YmplY3Q8YW55PjtcclxuXHJcbiAgcHJvdGVjdGVkIGFic3RyYWN0IGdldCB2aWV3cG9ydFNjcm9sbFNpemUoKTogbnVtYmVyO1xyXG5cclxuICBwcm90ZWN0ZWQgY29uc3RydWN0b3IocHVibGljIGNtcDogTmdTY3JvbGxiYXIsIHByb3RlY3RlZCBwbGF0Zm9ybTogUGxhdGZvcm0sIHByb3RlY3RlZCBkb2N1bWVudDogYW55LCBwcm90ZWN0ZWQgem9uZTogTmdab25lKSB7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBBY3RpdmF0ZSBzY3JvbGxiYXIgcG9pbnRlciBldmVudHNcclxuICAgKi9cclxuICBwcml2YXRlIGFjdGl2YXRlUG9pbnRlckV2ZW50cygpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgLy8gU3RyZWFtIHRoYXQgZW1pdHMgd2hlbiBzY3JvbGxiYXIgdGh1bWIgaXMgZHJhZ2dlZFxyXG4gICAgbGV0IHRodW1iRHJhZ0V2ZW50OiBPYnNlcnZhYmxlPGFueT4gPSBFTVBUWTtcclxuICAgIC8vIFN0cmVhbSB0aGF0IGVtaXRzIHdoZW4gc2Nyb2xsYmFyIHRyYWNrIGlzIGNsaWNrZWRcclxuICAgIGxldCB0cmFja0NsaWNrRXZlbnQ6IE9ic2VydmFibGU8YW55PiA9IEVNUFRZO1xyXG4gICAgLy8gU3RyZWFtIHRoYXQgZW1pdHMgd2hlbiBzY3JvbGxiYXIgdHJhY2sgaXMgaG92ZXJlZFxyXG4gICAgbGV0IHRyYWNrSG92ZXJlZEV2ZW50OiBPYnNlcnZhYmxlPGFueT4gPSBFTVBUWTtcclxuXHJcbiAgICAvLyBTZXQgdGhlIG1ldGhvZCB1c2VkIGZvciB0aGUgcG9pbnRlciBldmVudHMgb3B0aW9uXHJcbiAgICBpZiAodGhpcy5jbXAucG9pbnRlckV2ZW50c01ldGhvZCA9PT0gJ3ZpZXdwb3J0Jykge1xyXG4gICAgICAvLyBQb2ludGVyIGV2ZW50cyB1c2luZyB0aGUgdmlld3BvcnRcclxuICAgICAgdGhpcy52aWV3cG9ydFRyYWNrQ2xpY2tlZCA9IG5ldyBTdWJqZWN0PGFueT4oKTtcclxuICAgICAgdGhpcy52aWV3cG9ydFRodW1iQ2xpY2tlZCA9IG5ldyBTdWJqZWN0PGFueT4oKTtcclxuXHJcbiAgICAgIC8vIEFjdGl2YXRlIHRoZSBwb2ludGVyIGV2ZW50cyBvZiB0aGUgdmlld3BvcnQgZGlyZWN0aXZlXHJcbiAgICAgIHRoaXMuY21wLnZpZXdwb3J0LmFjdGl2YXRlUG9pbnRlckV2ZW50cyh0aGlzLmRlc3Ryb3llZCk7XHJcblxyXG4gICAgICAvLyBTZXQgc3RyZWFtc1xyXG4gICAgICB0aHVtYkRyYWdFdmVudCA9IHRoaXMudmlld3BvcnRUaHVtYkNsaWNrZWQ7XHJcbiAgICAgIHRyYWNrQ2xpY2tFdmVudCA9IHRoaXMudmlld3BvcnRUcmFja0NsaWNrZWQ7XHJcbiAgICAgIHRyYWNrSG92ZXJlZEV2ZW50ID0gdGhpcy5jbXAudmlld3BvcnQuaG92ZXJlZC5waXBlKFxyXG4gICAgICAgIC8vIENoZWNrIGlmIHRyYWNrIGlzIGhvdmVyZWRcclxuICAgICAgICBtYXAoKGU6IGFueSkgPT4gaXNXaXRoaW5Cb3VuZHMoZSwgdGhpcy50cmFjay5jbGllbnRSZWN0KSksXHJcbiAgICAgICAgZGlzdGluY3RVbnRpbENoYW5nZWQoKSxcclxuICAgICAgICAvLyBFbmFibGUgLyBkaXNhYmxlIHRleHQgc2VsZWN0aW9uXHJcbiAgICAgICAgdGFwKChob3ZlcmVkOiBib29sZWFuKSA9PiB0aGlzLmRvY3VtZW50Lm9uc2VsZWN0c3RhcnQgPSBob3ZlcmVkID8gKCkgPT4gZmFsc2UgOiBudWxsKVxyXG4gICAgICApO1xyXG5cclxuICAgICAgdGhpcy5jbXAudmlld3BvcnQuY2xpY2tlZC5waXBlKFxyXG4gICAgICAgIHRhcCgoZTogYW55KSA9PiB7XHJcbiAgICAgICAgICBpZiAoZSkge1xyXG4gICAgICAgICAgICBpZiAoaXNXaXRoaW5Cb3VuZHMoZSwgdGhpcy50aHVtYi5jbGllbnRSZWN0KSkge1xyXG4gICAgICAgICAgICAgIHRoaXMudmlld3BvcnRUaHVtYkNsaWNrZWQubmV4dChlKTtcclxuICAgICAgICAgICAgfSBlbHNlIGlmIChpc1dpdGhpbkJvdW5kcyhlLCB0aGlzLnRyYWNrLmNsaWVudFJlY3QpKSB7XHJcbiAgICAgICAgICAgICAgdGhpcy5jbXAuc2V0Q2xpY2tlZCh0cnVlKTtcclxuICAgICAgICAgICAgICB0aGlzLnZpZXdwb3J0VHJhY2tDbGlja2VkLm5leHQoZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuY21wLnNldENsaWNrZWQoZmFsc2UpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pLFxyXG4gICAgICAgIHRha2VVbnRpbCh0aGlzLmRlc3Ryb3llZClcclxuICAgICAgKS5zdWJzY3JpYmUoKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIC8vIFBvaW50ZXIgZXZlbnRzIG1ldGhvZCBpcyB1c2luZyAnc2Nyb2xsYmFyJ1xyXG4gICAgICB0aHVtYkRyYWdFdmVudCA9IHRoaXMudGh1bWIuY2xpY2tlZDtcclxuICAgICAgdHJhY2tDbGlja0V2ZW50ID0gdGhpcy50cmFjay5jbGlja2VkO1xyXG4gICAgICB0cmFja0hvdmVyZWRFdmVudCA9IHRoaXMudHJhY2suaG92ZXJlZDtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gbWVyZ2UoXHJcbiAgICAgIC8vIEFjdGl2YXRlIHNjcm9sbGJhciBob3ZlcmVkIGV2ZW50XHJcbiAgICAgIHRyYWNrSG92ZXJlZEV2ZW50LnBpcGUodGFwKChlOiBib29sZWFuKSA9PiB0aGlzLnNldEhvdmVyZWQoZSkpKSxcclxuICAgICAgLy8gQWN0aXZhdGUgc2Nyb2xsYmFyIHRodW1iIGRyYWcgZXZlbnRcclxuICAgICAgdGh1bWJEcmFnRXZlbnQucGlwZShzd2l0Y2hNYXAoKGU6IGFueSkgPT4gdGhpcy50aHVtYi5kcmFnZ2VkKGUpKSksXHJcbiAgICAgIC8vIEFjdGl2YXRlIHNjcm9sbGJhciB0cmFjayBjbGljayBldmVudFxyXG4gICAgICB0cmFja0NsaWNrRXZlbnQucGlwZShzd2l0Y2hNYXAoKGU6IGFueSkgPT4gdGhpcy50cmFjay5vblRyYWNrQ2xpY2tlZChlLCB0aGlzLnRodW1iLnNpemUsIHRoaXMudmlld3BvcnRTY3JvbGxTaXplKSkpXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgbmdPbkluaXQoKSB7XHJcbiAgICB0aGlzLnpvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4ge1xyXG4gICAgICAvLyBBY3RpdmF0ZSBwb2ludGVyIGV2ZW50cyBvbiBEZXNrdG9wIG9ubHlcclxuICAgICAgaWYgKCEodGhpcy5wbGF0Zm9ybS5JT1MgfHwgdGhpcy5wbGF0Zm9ybS5BTkRST0lEKSAmJiAhdGhpcy5jbXAucG9pbnRlckV2ZW50c0Rpc2FibGVkKSB7XHJcbiAgICAgICAgdGhpcy5hY3RpdmF0ZVBvaW50ZXJFdmVudHMoKS5waXBlKHRha2VVbnRpbCh0aGlzLmRlc3Ryb3llZCkpLnN1YnNjcmliZSgpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBTdHJlYW0gdGhhdCBlbWl0cyB3aGVuIGhvc3QgY29tcG9uZW50IGlzIHVwZGF0ZWRcclxuICAgICAgY29uc3QgdXBkYXRlZCA9IHRoaXMuY21wLnVwZGF0ZWQucGlwZSh0YXAoKCkgPT4gdGhpcy5vblVwZGF0ZWQoKSkpO1xyXG5cclxuICAgICAgLy8gVXBkYXRlIHNjcm9sbGJhciB0aHVtYiB3aGVuIHZpZXdwb3J0IGlzIHNjcm9sbGVkIGFuZCB3aGVuIHNjcm9sbGJhciBjb21wb25lbnQgaXMgdXBkYXRlZFxyXG4gICAgICBtZXJnZSh0aGlzLmNtcC5zY3JvbGxlZCwgdXBkYXRlZCkucGlwZShcclxuICAgICAgICB0YXAoKCkgPT4gdGhpcy50aHVtYi51cGRhdGUoKSksXHJcbiAgICAgICAgdGFrZVVudGlsKHRoaXMuZGVzdHJveWVkKVxyXG4gICAgICApLnN1YnNjcmliZSgpO1xyXG5cclxuICAgICAgLy8gSW5pdGlhbGl6ZSBzY3JvbGxiYXJcclxuICAgICAgYXN5bmNTY2hlZHVsZXIuc2NoZWR1bGUoKCkgPT4gdGhpcy50aHVtYi51cGRhdGUoKSwgMTAwKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgbmdPbkRlc3Ryb3koKSB7XHJcbiAgICB0aGlzLmRlc3Ryb3llZC5uZXh0KCk7XHJcbiAgICB0aGlzLmRlc3Ryb3llZC5jb21wbGV0ZSgpO1xyXG5cclxuICAgIC8vIENsZWFuIHVwIHZpZXdwb3J0IHN0cmVhbXMgaWYgdXNlZFxyXG4gICAgaWYgKHRoaXMudmlld3BvcnRUaHVtYkNsaWNrZWQgJiYgdGhpcy52aWV3cG9ydFRyYWNrQ2xpY2tlZCkge1xyXG4gICAgICB0aGlzLnZpZXdwb3J0VHJhY2tDbGlja2VkLmNvbXBsZXRlKCk7XHJcbiAgICAgIHRoaXMudmlld3BvcnRUaHVtYkNsaWNrZWQuY29tcGxldGUoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByb3RlY3RlZCBhYnN0cmFjdCBzZXRIb3ZlcmVkKHZhbHVlOiBib29sZWFuKTogdm9pZDtcclxuXHJcbiAgcHJvdGVjdGVkIGFic3RyYWN0IG9uVXBkYXRlZCgpOiB2b2lkO1xyXG59XHJcbiJdfQ==