/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { asyncScheduler, EMPTY, merge, Subject } from 'rxjs';
import { distinctUntilChanged, map, switchMap, takeUntil, tap } from 'rxjs/operators';
import { isWithinBounds } from './common';
/**
 * @abstract
 */
export class Scrollbar {
    /**
     * @protected
     * @param {?} cmp
     * @param {?} platform
     * @param {?} document
     * @param {?} zone
     */
    constructor(cmp, platform, document, zone) {
        this.cmp = cmp;
        this.platform = platform;
        this.document = document;
        this.zone = zone;
        // Stream that emits to unsubscribe from all streams
        this.destroyed = new Subject();
    }
    /**
     * Activate scrollbar pointer events
     * @private
     * @return {?}
     */
    activatePointerEvents() {
        // Stream that emits when scrollbar thumb is dragged
        /** @type {?} */
        let thumbDragEvent = EMPTY;
        // Stream that emits when scrollbar track is clicked
        /** @type {?} */
        let trackClickEvent = EMPTY;
        // Stream that emits when scrollbar track is hovered
        /** @type {?} */
        let trackHoveredEvent = EMPTY;
        // Set the method used for the pointer events option
        if (this.cmp.pointerEventsMethod === 'viewport') {
            // Pointer events using the viewport
            this.viewportTrackClicked = new Subject();
            this.viewportThumbClicked = new Subject();
            // Activate the pointer events of the viewport directive
            this.cmp.viewport.activatePointerEvents(this.destroyed);
            // Set streams
            thumbDragEvent = this.viewportThumbClicked;
            trackClickEvent = this.viewportTrackClicked;
            trackHoveredEvent = this.cmp.viewport.hovered.pipe(
            // Check if track is hovered
            map((/**
             * @param {?} e
             * @return {?}
             */
            (e) => isWithinBounds(e, this.track.clientRect))), distinctUntilChanged(), 
            // Enable / disable text selection
            tap((/**
             * @param {?} hovered
             * @return {?}
             */
            (hovered) => this.document.onselectstart = hovered ? (/**
             * @return {?}
             */
            () => false) : null)));
            this.cmp.viewport.clicked.pipe(tap((/**
             * @param {?} e
             * @return {?}
             */
            (e) => {
                if (e) {
                    if (isWithinBounds(e, this.thumb.clientRect)) {
                        this.viewportThumbClicked.next(e);
                    }
                    else if (isWithinBounds(e, this.track.clientRect)) {
                        this.cmp.setClicked(true);
                        this.viewportTrackClicked.next(e);
                    }
                }
                else {
                    this.cmp.setClicked(false);
                }
            })), takeUntil(this.destroyed)).subscribe();
        }
        else {
            // Pointer events method is using 'scrollbar'
            thumbDragEvent = this.thumb.clicked;
            trackClickEvent = this.track.clicked;
            trackHoveredEvent = this.track.hovered;
        }
        return merge(
        // Activate scrollbar hovered event
        trackHoveredEvent.pipe(tap((/**
         * @param {?} e
         * @return {?}
         */
        (e) => this.setHovered(e)))), 
        // Activate scrollbar thumb drag event
        thumbDragEvent.pipe(switchMap((/**
         * @param {?} e
         * @return {?}
         */
        (e) => this.thumb.dragged(e)))), 
        // Activate scrollbar track click event
        trackClickEvent.pipe(switchMap((/**
         * @param {?} e
         * @return {?}
         */
        (e) => this.track.onTrackClicked(e, this.thumb.size, this.viewportScrollSize)))));
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.zone.runOutsideAngular((/**
         * @return {?}
         */
        () => {
            // Activate pointer events on Desktop only
            if (!(this.platform.IOS || this.platform.ANDROID) && !this.cmp.pointerEventsDisabled) {
                this.activatePointerEvents().pipe(takeUntil(this.destroyed)).subscribe();
            }
            // Stream that emits when host component is updated
            /** @type {?} */
            const updated = this.cmp.updated.pipe(tap((/**
             * @return {?}
             */
            () => this.onUpdated())));
            // Update scrollbar thumb when viewport is scrolled and when scrollbar component is updated
            merge(this.cmp.scrolled, updated).pipe(tap((/**
             * @return {?}
             */
            () => this.thumb.update())), takeUntil(this.destroyed)).subscribe();
            // Initialize scrollbar
            asyncScheduler.schedule((/**
             * @return {?}
             */
            () => this.thumb.update()), 100);
        }));
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this.destroyed.next();
        this.destroyed.complete();
        // Clean up viewport streams if used
        if (this.viewportThumbClicked && this.viewportTrackClicked) {
            this.viewportTrackClicked.complete();
            this.viewportThumbClicked.complete();
        }
    }
}
if (false) {
    /** @type {?} */
    Scrollbar.prototype.thumb;
    /** @type {?} */
    Scrollbar.prototype.track;
    /**
     * @type {?}
     * @protected
     */
    Scrollbar.prototype.destroyed;
    /**
     * Viewport pointer events
     * The following streams are only activated when (pointerEventsMethod === 'viewport')
     * @type {?}
     * @protected
     */
    Scrollbar.prototype.viewportTrackClicked;
    /**
     * @type {?}
     * @protected
     */
    Scrollbar.prototype.viewportThumbClicked;
    /** @type {?} */
    Scrollbar.prototype.cmp;
    /**
     * @type {?}
     * @protected
     */
    Scrollbar.prototype.platform;
    /**
     * @type {?}
     * @protected
     */
    Scrollbar.prototype.document;
    /**
     * @type {?}
     * @protected
     */
    Scrollbar.prototype.zone;
    /**
     * @abstract
     * @protected
     * @return {?}
     */
    Scrollbar.prototype.viewportScrollSize = function () { };
    /**
     * @abstract
     * @protected
     * @param {?} value
     * @return {?}
     */
    Scrollbar.prototype.setHovered = function (value) { };
    /**
     * @abstract
     * @protected
     * @return {?}
     */
    Scrollbar.prototype.onUpdated = function () { };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2Nyb2xsYmFyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmd4LXNjcm9sbGJhci8iLCJzb3VyY2VzIjpbImxpYi9zY3JvbGxiYXIvc2Nyb2xsYmFyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFFQSxPQUFPLEVBQUUsY0FBYyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQWMsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3pFLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUl0RixPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sVUFBVSxDQUFDOzs7O0FBRTFDLE1BQU0sT0FBZ0IsU0FBUzs7Ozs7Ozs7SUFrQjdCLFlBQTZCLEdBQWdCLEVBQVksUUFBa0IsRUFBWSxRQUFhLEVBQVksSUFBWTtRQUEvRixRQUFHLEdBQUgsR0FBRyxDQUFhO1FBQVksYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUFZLGFBQVEsR0FBUixRQUFRLENBQUs7UUFBWSxTQUFJLEdBQUosSUFBSSxDQUFROztRQVh6RyxjQUFTLEdBQUcsSUFBSSxPQUFPLEVBQVEsQ0FBQztJQVluRCxDQUFDOzs7Ozs7SUFLTyxxQkFBcUI7OztZQUV2QixjQUFjLEdBQW9CLEtBQUs7OztZQUV2QyxlQUFlLEdBQW9CLEtBQUs7OztZQUV4QyxpQkFBaUIsR0FBb0IsS0FBSztRQUU5QyxvREFBb0Q7UUFDcEQsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLG1CQUFtQixLQUFLLFVBQVUsRUFBRTtZQUMvQyxvQ0FBb0M7WUFDcEMsSUFBSSxDQUFDLG9CQUFvQixHQUFHLElBQUksT0FBTyxFQUFPLENBQUM7WUFDL0MsSUFBSSxDQUFDLG9CQUFvQixHQUFHLElBQUksT0FBTyxFQUFPLENBQUM7WUFFL0Msd0RBQXdEO1lBQ3hELElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLHFCQUFxQixDQUFDLElBQUksQ0FB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SUFFN0IsMEJBQTZCOzs7OztJQUU3Qiw4QkFBbUQ7Ozs7Ozs7SUFNbkQseUNBQThDOzs7OztJQUM5Qyx5Q0FBOEM7O0lBSXhCLHdCQUF1Qjs7Ozs7SUFBRSw2QkFBNEI7Ozs7O0lBQUUsNkJBQXVCOzs7OztJQUFFLHlCQUFzQjs7Ozs7O0lBRjVILHlEQUFvRDs7Ozs7OztJQW9HcEQsc0RBQW9EOzs7Ozs7SUFFcEQsZ0RBQXFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgT25EZXN0cm95LCBPbkluaXQsIE5nWm9uZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBQbGF0Zm9ybSB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9wbGF0Zm9ybSc7XHJcbmltcG9ydCB7IGFzeW5jU2NoZWR1bGVyLCBFTVBUWSwgbWVyZ2UsIE9ic2VydmFibGUsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgZGlzdGluY3RVbnRpbENoYW5nZWQsIG1hcCwgc3dpdGNoTWFwLCB0YWtlVW50aWwsIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuaW1wb3J0IHsgTmdTY3JvbGxiYXIgfSBmcm9tICcuLi9uZy1zY3JvbGxiYXInO1xyXG5pbXBvcnQgeyBUaHVtYkFkYXB0ZXIgfSBmcm9tICcuL3RodW1iL3RodW1iJztcclxuaW1wb3J0IHsgVHJhY2tBZGFwdGVyIH0gZnJvbSAnLi90cmFjay90cmFjayc7XHJcbmltcG9ydCB7IGlzV2l0aGluQm91bmRzIH0gZnJvbSAnLi9jb21tb24nO1xyXG5cclxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIFNjcm9sbGJhciBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95IHtcclxuXHJcbiAgLy8gVGh1bWIgZGlyZWN0aXZlIHJlZmVyZW5jZVxyXG4gIHJlYWRvbmx5IHRodW1iOiBUaHVtYkFkYXB0ZXI7XHJcbiAgLy8gVHJhY2sgZGlyZWN0aXZlIHJlZmVyZW5jZVxyXG4gIHJlYWRvbmx5IHRyYWNrOiBUcmFja0FkYXB0ZXI7XHJcbiAgLy8gU3RyZWFtIHRoYXQgZW1pdHMgdG8gdW5zdWJzY3JpYmUgZnJvbSBhbGwgc3RyZWFtc1xyXG4gIHByb3RlY3RlZCByZWFkb25seSBkZXN0cm95ZWQgPSBuZXcgU3ViamVjdDx2b2lkPigpO1xyXG5cclxuICAvKipcclxuICAgKiBWaWV3cG9ydCBwb2ludGVyIGV2ZW50c1xyXG4gICAqIFRoZSBmb2xsb3dpbmcgc3RyZWFtcyBhcmUgb25seSBhY3RpdmF0ZWQgd2hlbiAocG9pbnRlckV2ZW50c01ldGhvZCA9PT0gJ3ZpZXdwb3J0JylcclxuICAgKi9cclxuICBwcm90ZWN0ZWQgdmlld3BvcnRUcmFja0NsaWNrZWQhOiBTdWJqZWN0PGFueT47XHJcbiAgcHJvdGVjdGVkIHZpZXdwb3J0VGh1bWJDbGlja2VkITogU3ViamVjdDxhbnk+O1xyXG5cclxuICBwcm90ZWN0ZWQgYWJzdHJhY3QgZ2V0IHZpZXdwb3J0U2Nyb2xsU2l6ZSgpOiBudW1iZXI7XHJcblxyXG4gIHByb3RlY3RlZCBjb25zdHJ1Y3RvcihwdWJsaWMgY21wOiBOZ1Njcm9sbGJhciwgcHJvdGVjdGVkIHBsYXRmb3JtOiBQbGF0Zm9ybSwgcHJvdGVjdGVkIGRvY3VtZW50OiBhbnksIHByb3RlY3RlZCB6b25lOiBOZ1pvbmUpIHtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEFjdGl2YXRlIHNjcm9sbGJhciBwb2ludGVyIGV2ZW50c1xyXG4gICAqL1xyXG4gIHByaXZhdGUgYWN0aXZhdGVQb2ludGVyRXZlbnRzKCk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICAvLyBTdHJlYW0gdGhhdCBlbWl0cyB3aGVuIHNjcm9sbGJhciB0aHVtYiBpcyBkcmFnZ2VkXHJcbiAgICBsZXQgdGh1bWJEcmFnRXZlbnQ6IE9ic2VydmFibGU8YW55PiA9IEVNUFRZO1xyXG4gICAgLy8gU3RyZWFtIHRoYXQgZW1pdHMgd2hlbiBzY3JvbGxiYXIgdHJhY2sgaXMgY2xpY2tlZFxyXG4gICAgbGV0IHRyYWNrQ2xpY2tFdmVudDogT2JzZXJ2YWJsZTxhbnk+ID0gRU1QVFk7XHJcbiAgICAvLyBTdHJlYW0gdGhhdCBlbWl0cyB3aGVuIHNjcm9sbGJhciB0cmFjayBpcyBob3ZlcmVkXHJcbiAgICBsZXQgdHJhY2tIb3ZlcmVkRXZlbnQ6IE9ic2VydmFibGU8YW55PiA9IEVNUFRZO1xyXG5cclxuICAgIC8vIFNldCB0aGUgbWV0aG9kIHVzZWQgZm9yIHRoZSBwb2ludGVyIGV2ZW50cyBvcHRpb25cclxuICAgIGlmICh0aGlzLmNtcC5wb2ludGVyRXZlbnRzTWV0aG9kID09PSAndmlld3BvcnQnKSB7XHJcbiAgICAgIC8vIFBvaW50ZXIgZXZlbnRzIHVzaW5nIHRoZSB2aWV3cG9ydFxyXG4gICAgICB0aGlzLnZpZXdwb3J0VHJhY2tDbGlja2VkID0gbmV3IFN1YmplY3Q8YW55PigpO1xyXG4gICAgICB0aGlzLnZpZXdwb3J0VGh1bWJDbGlja2VkID0gbmV3IFN1YmplY3Q8YW55PigpO1xyXG5cclxuICAgICAgLy8gQWN0aXZhdGUgdGhlIHBvaW50ZXIgZXZlbnRzIG9mIHRoZSB2aWV3cG9ydCBkaXJlY3RpdmVcclxuICAgICAgdGhpcy5jbXAudmlld3BvcnQuYWN0aXZhdGVQb2ludGVyRXZlbnRzKHRoaXMuZGVzdHJveWVkKTtcclxuXHJcbiAgICAgIC8vIFNldCBzdHJlYW1zXHJcbiAgICAgIHRodW1iRHJhZ0V2ZW50ID0gdGhpcy52aWV3cG9ydFRodW1iQ2xpY2tlZDtcclxuICAgICAgdHJhY2tDbGlja0V2ZW50ID0gdGhpcy52aWV3cG9ydFRyYWNrQ2xpY2tlZDtcclxuICAgICAgdHJhY2tIb3ZlcmVkRXZlbnQgPSB0aGlzLmNtcC52aWV3cG9ydC5ob3ZlcmVkLnBpcGUoXHJcbiAgICAgICAgLy8gQ2hlY2sgaWYgdHJhY2sgaXMgaG92ZXJlZFxyXG4gICAgICAgIG1hcCgoZTogYW55KSA9PiBpc1dpdGhpbkJvdW5kcyhlLCB0aGlzLnRyYWNrLmNsaWVudFJlY3QpKSxcclxuICAgICAgICBkaXN0aW5jdFVudGlsQ2hhbmdlZCgpLFxyXG4gICAgICAgIC8vIEVuYWJsZSAvIGRpc2FibGUgdGV4dCBzZWxlY3Rpb25cclxuICAgICAgICB0YXAoKGhvdmVyZWQ6IGJvb2xlYW4pID0+IHRoaXMuZG9jdW1lbnQub25zZWxlY3RzdGFydCA9IGhvdmVyZWQgPyAoKSA9PiBmYWxzZSA6IG51bGwpXHJcbiAgICAgICk7XHJcblxyXG4gICAgICB0aGlzLmNtcC52aWV3cG9ydC5jbGlja2VkLnBpcGUoXHJcbiAgICAgICAgdGFwKChlOiBhbnkpID0+IHtcclxuICAgICAgICAgIGlmIChlKSB7XHJcbiAgICAgICAgICAgIGlmIChpc1dpdGhpbkJvdW5kcyhlLCB0aGlzLnRodW1iLmNsaWVudFJlY3QpKSB7XHJcbiAgICAgICAgICAgICAgdGhpcy52aWV3cG9ydFRodW1iQ2xpY2tlZC5uZXh0KGUpO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKGlzV2l0aGluQm91bmRzKGUsIHRoaXMudHJhY2suY2xpZW50UmVjdCkpIHtcclxuICAgICAgICAgICAgICB0aGlzLmNtcC5zZXRDbGlja2VkKHRydWUpO1xyXG4gICAgICAgICAgICAgIHRoaXMudmlld3BvcnRUcmFja0NsaWNrZWQubmV4dChlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5jbXAuc2V0Q2xpY2tlZChmYWxzZSk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSksXHJcbiAgICAgICAgdGFrZVVudGlsKHRoaXMuZGVzdHJveWVkKVxyXG4gICAgICApLnN1YnNjcmliZSgpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgLy8gUG9pbnRlciBldmVudHMgbWV0aG9kIGlzIHVzaW5nICdzY3JvbGxiYXInXHJcbiAgICAgIHRodW1iRHJhZ0V2ZW50ID0gdGhpcy50aHVtYi5jbGlja2VkO1xyXG4gICAgICB0cmFja0NsaWNrRXZlbnQgPSB0aGlzLnRyYWNrLmNsaWNrZWQ7XHJcbiAgICAgIHRyYWNrSG92ZXJlZEV2ZW50ID0gdGhpcy50cmFjay5ob3ZlcmVkO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBtZXJnZShcclxuICAgICAgLy8gQWN0aXZhdGUgc2Nyb2xsYmFyIGhvdmVyZWQgZXZlbnRcclxuICAgICAgdHJhY2tIb3ZlcmVkRXZlbnQucGlwZSh0YXAoKGU6IGJvb2xlYW4pID0+IHRoaXMuc2V0SG92ZXJlZChlKSkpLFxyXG4gICAgICAvLyBBY3RpdmF0ZSBzY3JvbGxiYXIgdGh1bWIgZHJhZyBldmVudFxyXG4gICAgICB0aHVtYkRyYWdFdmVudC5waXBlKHN3aXRjaE1hcCgoZTogYW55KSA9PiB0aGlzLnRodW1iLmRyYWdnZWQoZSkpKSxcclxuICAgICAgLy8gQWN0aXZhdGUgc2Nyb2xsYmFyIHRyYWNrIGNsaWNrIGV2ZW50XHJcbiAgICAgIHRyYWNrQ2xpY2tFdmVudC5waXBlKHN3aXRjaE1hcCgoZTogYW55KSA9PiB0aGlzLnRyYWNrLm9uVHJhY2tDbGlja2VkKGUsIHRoaXMudGh1bWIuc2l6ZSwgdGhpcy52aWV3cG9ydFNjcm9sbFNpemUpKSlcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBuZ09uSW5pdCgpIHtcclxuICAgIHRoaXMuem9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiB7XHJcbiAgICAgIC8vIEFjdGl2YXRlIHBvaW50ZXIgZXZlbnRzIG9uIERlc2t0b3Agb25seVxyXG4gICAgICBpZiAoISh0aGlzLnBsYXRmb3JtLklPUyB8fCB0aGlzLnBsYXRmb3JtLkFORFJPSUQpICYmICF0aGlzLmNtcC5wb2ludGVyRXZlbnRzRGlzYWJsZWQpIHtcclxuICAgICAgICB0aGlzLmFjdGl2YXRlUG9pbnRlckV2ZW50cygpLnBpcGUodGFrZVVudGlsKHRoaXMuZGVzdHJveWVkKSkuc3Vic2NyaWJlKCk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIFN0cmVhbSB0aGF0IGVtaXRzIHdoZW4gaG9zdCBjb21wb25lbnQgaXMgdXBkYXRlZFxyXG4gICAgICBjb25zdCB1cGRhdGVkID0gdGhpcy5jbXAudXBkYXRlZC5waXBlKHRhcCgoKSA9PiB0aGlzLm9uVXBkYXRlZCgpKSk7XHJcblxyXG4gICAgICAvLyBVcGRhdGUgc2Nyb2xsYmFyIHRodW1iIHdoZW4gdmlld3BvcnQgaXMgc2Nyb2xsZWQgYW5kIHdoZW4gc2Nyb2xsYmFyIGNvbXBvbmVudCBpcyB1cGRhdGVkXHJcbiAgICAgIG1lcmdlKHRoaXMuY21wLnNjcm9sbGVkLCB1cGRhdGVkKS5waXBlKFxyXG4gICAgICAgIHRhcCgoKSA9PiB0aGlzLnRodW1iLnVwZGF0ZSgpKSxcclxuICAgICAgICB0YWtlVW50aWwodGhpcy5kZXN0cm95ZWQpXHJcbiAgICAgICkuc3Vic2NyaWJlKCk7XHJcblxyXG4gICAgICAvLyBJbml0aWFsaXplIHNjcm9sbGJhclxyXG4gICAgICBhc3luY1NjaGVkdWxlci5zY2hlZHVsZSgoKSA9PiB0aGlzLnRodW1iLnVwZGF0ZSgpLCAxMDApO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBuZ09uRGVzdHJveSgpIHtcclxuICAgIHRoaXMuZGVzdHJveWVkLm5leHQoKTtcclxuICAgIHRoaXMuZGVzdHJveWVkLmNvbXBsZXRlKCk7XHJcblxyXG4gICAgLy8gQ2xlYW4gdXAgdmlld3BvcnQgc3RyZWFtcyBpZiB1c2VkXHJcbiAgICBpZiAodGhpcy52aWV3cG9ydFRodW1iQ2xpY2tlZCAmJiB0aGlzLnZpZXdwb3J0VHJhY2tDbGlja2VkKSB7XHJcbiAgICAgIHRoaXMudmlld3BvcnRUcmFja0NsaWNrZWQuY29tcGxldGUoKTtcclxuICAgICAgdGhpcy52aWV3cG9ydFRodW1iQ2xpY2tlZC5jb21wbGV0ZSgpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJvdGVjdGVkIGFic3RyYWN0IHNldEhvdmVyZWQodmFsdWU6IGJvb2xlYW4pOiB2b2lkO1xyXG5cclxuICBwcm90ZWN0ZWQgYWJzdHJhY3Qgb25VcGRhdGVkKCk6IHZvaWQ7XHJcbn1cclxuIl19