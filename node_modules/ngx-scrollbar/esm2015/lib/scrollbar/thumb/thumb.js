/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Input, Output } from '@angular/core';
import { animationFrameScheduler, of, fromEvent, Subject } from 'rxjs';
import { distinctUntilChanged, map, mergeMap, pluck, takeUntil, tap } from 'rxjs/operators';
import { enableSelection, preventSelection, stopPropagation } from '../common';
import { TrackAdapter } from '../track/track';
/**
 * @abstract
 */
export class ThumbAdapter {
    /**
     * @protected
     * @param {?} cmp
     * @param {?} thumbElement
     * @param {?} document
     */
    constructor(cmp, thumbElement, document) {
        this.cmp = cmp;
        this.thumbElement = thumbElement;
        this.document = document;
        // Stream that emits dragging state
        this._dragging = new Subject();
        this.dragging = this._dragging.pipe(distinctUntilChanged());
    }
    /**
     * @return {?}
     */
    get trackMax() {
        return this.track.size - this.size;
    }
    // Get thumb client rect
    /**
     * @return {?}
     */
    get clientRect() {
        return this.thumbElement.getBoundingClientRect();
    }
    // Stream that emits when scrollbar thumb is clicked
    /**
     * @return {?}
     */
    get clicked() {
        return fromEvent(this.thumbElement, 'mousedown', { passive: true }).pipe(stopPropagation());
    }
    // Calculate and update thumb position and size
    /**
     * @return {?}
     */
    update() {
        /** @type {?} */
        const size = calculateThumbSize(this.track.size, this.viewportScrollSize, (/** @type {?} */ (this.cmp.minThumbSize)));
        /** @type {?} */
        const position = calculateThumbPosition(this.viewportScrollOffset, this.viewportScrollMax, this.trackMax);
        animationFrameScheduler.schedule((/**
         * @return {?}
         */
        () => this.updateStyles(this.handleDirection(position, this.trackMax), size)));
    }
    /**
     * Stream that emits the 'scrollTo' position when a scrollbar thumb element is dragged
     * This function is called by thumb drag event using viewport or scrollbar pointer events
     * @param {?} event
     * @return {?}
     */
    dragged(event) {
        /** @type {?} */
        let trackMaxStart;
        /** @type {?} */
        let scrollMaxStart;
        /** @type {?} */
        const dragStart = of(event).pipe(preventSelection(this.document), tap((/**
         * @return {?}
         */
        () => {
            // Capture scrollMax and trackMax once
            trackMaxStart = this.trackMax;
            scrollMaxStart = this.viewportScrollMax;
            this.setDragging(true);
        })));
        /** @type {?} */
        const dragging = fromEvent(this.document, 'mousemove', { capture: true, passive: true }).pipe(stopPropagation());
        /** @type {?} */
        const dragEnd = fromEvent(this.document, 'mouseup', { capture: true }).pipe(stopPropagation(), enableSelection(this.document), tap((/**
         * @return {?}
         */
        () => this.setDragging(false))));
        return dragStart.pipe(pluck(this.pageProperty), map((/**
         * @param {?} pageOffset
         * @return {?}
         */
        (pageOffset) => pageOffset - this.dragStartOffset)), mergeMap((/**
         * @param {?} mouseDownOffset
         * @return {?}
         */
        (mouseDownOffset) => dragging.pipe(pluck(this.clientProperty), 
        // Calculate how far the pointer is from the top/left of the scrollbar (minus the dragOffset).
        map((/**
         * @param {?} mouseOffset
         * @return {?}
         */
        (mouseOffset) => mouseOffset - this.track.offset)), map((/**
         * @param {?} offset
         * @return {?}
         */
        (offset) => scrollMaxStart * (offset - mouseDownOffset) / trackMaxStart)), map((/**
         * @param {?} position
         * @return {?}
         */
        (position) => this.handleDrag(position, scrollMaxStart))), tap((/**
         * @param {?} position
         * @return {?}
         */
        (position) => this.scrollTo(position))), takeUntil(dragEnd)))));
    }
}
ThumbAdapter.propDecorators = {
    track: [{ type: Input }],
    dragging: [{ type: Output }]
};
if (false) {
    /** @type {?} */
    ThumbAdapter.prototype.track;
    /**
     * @type {?}
     * @private
     */
    ThumbAdapter.prototype._dragging;
    /** @type {?} */
    ThumbAdapter.prototype.dragging;
    /**
     * @type {?}
     * @protected
     */
    ThumbAdapter.prototype.cmp;
    /**
     * @type {?}
     * @protected
     */
    ThumbAdapter.prototype.thumbElement;
    /**
     * @type {?}
     * @protected
     */
    ThumbAdapter.prototype.document;
    /**
     * @abstract
     * @protected
     * @return {?}
     */
    ThumbAdapter.prototype.pageProperty = function () { };
    /**
     * @abstract
     * @protected
     * @return {?}
     */
    ThumbAdapter.prototype.clientProperty = function () { };
    /**
     * @abstract
     * @return {?}
     */
    ThumbAdapter.prototype.dragStartOffset = function () { };
    /**
     * @abstract
     * @return {?}
     */
    ThumbAdapter.prototype.size = function () { };
    /**
     * @abstract
     * @protected
     * @return {?}
     */
    ThumbAdapter.prototype.viewportScrollSize = function () { };
    /**
     * @abstract
     * @protected
     * @return {?}
     */
    ThumbAdapter.prototype.viewportScrollOffset = function () { };
    /**
     * @abstract
     * @return {?}
     */
    ThumbAdapter.prototype.viewportScrollMax = function () { };
    /**
     * @abstract
     * @protected
     * @param {?} value
     * @return {?}
     */
    ThumbAdapter.prototype.setDragging = function (value) { };
    /**
     * @abstract
     * @protected
     * @param {?} position
     * @return {?}
     */
    ThumbAdapter.prototype.scrollTo = function (position) { };
    /**
     * @abstract
     * @protected
     * @param {?} position
     * @param {?} size
     * @return {?}
     */
    ThumbAdapter.prototype.updateStyles = function (position, size) { };
    /**
     * @abstract
     * @protected
     * @param {?} position
     * @param {?=} scrollMax
     * @return {?}
     */
    ThumbAdapter.prototype.handleDrag = function (position, scrollMax) { };
    /**
     * @abstract
     * @protected
     * @param {?} position
     * @param {?=} scrollMax
     * @return {?}
     */
    ThumbAdapter.prototype.handleDirection = function (position, scrollMax) { };
}
/**
 * Calculate scrollbar thumb size
 * @param {?} trackSize
 * @param {?} contentSize
 * @param {?} minThumbSize
 * @return {?}
 */
function calculateThumbSize(trackSize, contentSize, minThumbSize) {
    /** @type {?} */
    const scrollbarRatio = trackSize / contentSize;
    /** @type {?} */
    const thumbSize = scrollbarRatio * trackSize;
    return Math.max(~~thumbSize, minThumbSize);
}
/**
 * Calculate scrollbar thumb position
 * @param {?} scrollPosition
 * @param {?} scrollMax
 * @param {?} trackMax
 * @return {?}
 */
function calculateThumbPosition(scrollPosition, scrollMax, trackMax) {
    return scrollPosition * trackMax / scrollMax;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGh1bWIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZ3gtc2Nyb2xsYmFyLyIsInNvdXJjZXMiOlsibGliL3Njcm9sbGJhci90aHVtYi90aHVtYi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDOUMsT0FBTyxFQUFFLHVCQUF1QixFQUFFLEVBQUUsRUFBRSxTQUFTLEVBQWMsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ25GLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxHQUFHLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDNUYsT0FBTyxFQUFFLGVBQWUsRUFBRSxnQkFBZ0IsRUFBRSxlQUFlLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFFL0UsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGdCQUFnQixDQUFDOzs7O0FBRTlDLE1BQU0sT0FBZ0IsWUFBWTs7Ozs7OztJQXVDaEMsWUFBZ0MsR0FBZ0IsRUFDaEIsWUFBeUIsRUFDekIsUUFBYTtRQUZiLFFBQUcsR0FBSCxHQUFHLENBQWE7UUFDaEIsaUJBQVksR0FBWixZQUFZLENBQWE7UUFDekIsYUFBUSxHQUFSLFFBQVEsQ0FBSzs7UUFwQ3JDLGNBQVMsR0FBRyxJQUFJLE9BQU8sRUFBVyxDQUFDO1FBQ2pDLGFBQVEsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxDQUFDLENBQUM7SUFvQ2pFLENBQUM7Ozs7SUFqQkQsSUFBSSxRQUFRO1FBQ1YsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDO0lBQ3JDLENBQUM7Ozs7O0lBR0QsSUFBSSxVQUFVO1FBQ1osT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLHFCQUFxQixFQUFFLENBQUM7SUFDbkQsQ0FBQzs7Ozs7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LE9BQU8sQ0FBQyxDQUNuQixFQUFDLENBQ0gsQ0FBQztJQUNKLENBQUM7OztvQkF4RkEsS0FBSzt1QkFJTCxNQUFNOzs7O0lBSlAsNkJBQTZCOzs7OztJQUc3QixpQ0FBMkM7O0lBQzNDLGdDQUFpRTs7Ozs7SUFpQzNDLDJCQUEwQjs7Ozs7SUFDMUIsb0NBQW1DOzs7OztJQUNuQyxnQ0FBdUI7Ozs7OztJQWhDN0Msc0RBQThDOzs7Ozs7SUFHOUMsd0RBQWdEOzs7OztJQUVoRCx5REFBdUM7Ozs7O0lBR3ZDLDhDQUE0Qjs7Ozs7O0lBRTVCLDREQUFvRDs7Ozs7O0lBRXBELDhEQUFzRDs7Ozs7SUFFdEQsMkRBQXlDOzs7Ozs7O0lBc0V6QywwREFBcUQ7Ozs7Ozs7SUFHckQsMERBQW9EOzs7Ozs7OztJQUdwRCxvRUFBc0U7Ozs7Ozs7O0lBR3RFLHVFQUE0RTs7Ozs7Ozs7SUFHNUUsNEVBQWlGOzs7Ozs7Ozs7QUFNbkYsU0FBUyxrQkFBa0IsQ0FBQyxTQUFpQixFQUFFLFdBQW1CLEVBQUUsWUFBb0I7O1VBQ2hGLGNBQWMsR0FBRyxTQUFTLEdBQUcsV0FBVzs7VUFDeEMsU0FBUyxHQUFHLGNBQWMsR0FBRyxTQUFTO0lBQzVDLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsU0FBUyxFQUFFLFlBQVksQ0FBQyxDQUFDO0FBQzdDLENBQUM7Ozs7Ozs7O0FBS0QsU0FBUyxzQkFBc0IsQ0FBQyxjQUFzQixFQUFFLFNBQWlCLEVBQUUsUUFBZ0I7SUFDekYsT0FBTyxjQUFjLEdBQUcsUUFBUSxHQUFHLFNBQVMsQ0FBQztBQUMvQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5wdXQsIE91dHB1dCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBhbmltYXRpb25GcmFtZVNjaGVkdWxlciwgb2YsIGZyb21FdmVudCwgT2JzZXJ2YWJsZSwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBkaXN0aW5jdFVudGlsQ2hhbmdlZCwgbWFwLCBtZXJnZU1hcCwgcGx1Y2ssIHRha2VVbnRpbCwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBlbmFibGVTZWxlY3Rpb24sIHByZXZlbnRTZWxlY3Rpb24sIHN0b3BQcm9wYWdhdGlvbiB9IGZyb20gJy4uL2NvbW1vbic7XHJcbmltcG9ydCB7IE5nU2Nyb2xsYmFyIH0gZnJvbSAnLi4vLi4vbmctc2Nyb2xsYmFyJztcclxuaW1wb3J0IHsgVHJhY2tBZGFwdGVyIH0gZnJvbSAnLi4vdHJhY2svdHJhY2snO1xyXG5cclxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIFRodW1iQWRhcHRlciB7XHJcblxyXG4gIEBJbnB1dCgpIHRyYWNrOiBUcmFja0FkYXB0ZXI7XHJcblxyXG4gIC8vIFN0cmVhbSB0aGF0IGVtaXRzIGRyYWdnaW5nIHN0YXRlXHJcbiAgcHJpdmF0ZSBfZHJhZ2dpbmcgPSBuZXcgU3ViamVjdDxib29sZWFuPigpO1xyXG4gIEBPdXRwdXQoKSBkcmFnZ2luZyA9IHRoaXMuX2RyYWdnaW5nLnBpcGUoZGlzdGluY3RVbnRpbENoYW5nZWQoKSk7XHJcblxyXG4gIC8vIFJldHVybnMgZWl0aGVyICdwYWdlWCcgb3IgJ3BhZ2VZJyBhY2NvcmRpbmcgdG8gc2Nyb2xsYmFyIGF4aXNcclxuICBwcm90ZWN0ZWQgYWJzdHJhY3QgZ2V0IHBhZ2VQcm9wZXJ0eSgpOiBzdHJpbmc7XHJcblxyXG4gIC8vIFJldHVybnMgZWl0aGVyICdjbGllbnRIZWlnaHQnIG9yICdjbGllbnRXaWR0aCcgYWNjb3JkaW5nIHRvIHNjcm9sbGJhciBheGlzXHJcbiAgcHJvdGVjdGVkIGFic3RyYWN0IGdldCBjbGllbnRQcm9wZXJ0eSgpOiBzdHJpbmc7XHJcblxyXG4gIGFic3RyYWN0IGdldCBkcmFnU3RhcnRPZmZzZXQoKTogbnVtYmVyO1xyXG5cclxuICAvLyBSZXR1cm5zIHRodW1iIHNpemUsIGNsaWVudEhlaWdodCBvciBjbGllbnRXaWR0aFxyXG4gIGFic3RyYWN0IGdldCBzaXplKCk6IG51bWJlcjtcclxuXHJcbiAgcHJvdGVjdGVkIGFic3RyYWN0IGdldCB2aWV3cG9ydFNjcm9sbFNpemUoKTogbnVtYmVyO1xyXG5cclxuICBwcm90ZWN0ZWQgYWJzdHJhY3QgZ2V0IHZpZXdwb3J0U2Nyb2xsT2Zmc2V0KCk6IG51bWJlcjtcclxuXHJcbiAgYWJzdHJhY3QgZ2V0IHZpZXdwb3J0U2Nyb2xsTWF4KCk6IG51bWJlcjtcclxuXHJcbiAgZ2V0IHRyYWNrTWF4KCk6IG51bWJlciB7XHJcbiAgICByZXR1cm4gdGhpcy50cmFjay5zaXplIC0gdGhpcy5zaXplO1xyXG4gIH1cclxuXHJcbiAgLy8gR2V0IHRodW1iIGNsaWVudCByZWN0XHJcbiAgZ2V0IGNsaWVudFJlY3QoKTogQ2xpZW50UmVjdCB7XHJcbiAgICByZXR1cm4gdGhpcy50aHVtYkVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XHJcbiAgfVxyXG5cclxuICAvLyBTdHJlYW0gdGhhdCBlbWl0cyB3aGVuIHNjcm9sbGJhciB0aHVtYiBpcyBjbGlja2VkXHJcbiAgZ2V0IGNsaWNrZWQoKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIHJldHVybiBmcm9tRXZlbnQodGhpcy50aHVtYkVsZW1lbnQsICdtb3VzZWRvd24nLCB7IHBhc3NpdmU6IHRydWUgfSkucGlwZShzdG9wUHJvcGFnYXRpb24oKSk7XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgY29uc3RydWN0b3IocHJvdGVjdGVkIGNtcDogTmdTY3JvbGxiYXIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb3RlY3RlZCB0aHVtYkVsZW1lbnQ6IEhUTUxFbGVtZW50LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBwcm90ZWN0ZWQgZG9jdW1lbnQ6IGFueSkge1xyXG4gIH1cclxuXHJcbiAgLy8gQ2FsY3VsYXRlIGFuZCB1cGRhdGUgdGh1bWIgcG9zaXRpb24gYW5kIHNpemVcclxuICB1cGRhdGUoKSB7XHJcbiAgICBjb25zdCBzaXplID0gY2FsY3VsYXRlVGh1bWJTaXplKHRoaXMudHJhY2suc2l6ZSwgdGhpcy52aWV3cG9ydFNjcm9sbFNpemUsIHRoaXMuY21wLm1pblRodW1iU2l6ZSEpO1xyXG4gICAgY29uc3QgcG9zaXRpb24gPSBjYWxjdWxhdGVUaHVtYlBvc2l0aW9uKHRoaXMudmlld3BvcnRTY3JvbGxPZmZzZXQsIHRoaXMudmlld3BvcnRTY3JvbGxNYXgsIHRoaXMudHJhY2tNYXgpO1xyXG4gICAgYW5pbWF0aW9uRnJhbWVTY2hlZHVsZXIuc2NoZWR1bGUoKCkgPT4gdGhpcy51cGRhdGVTdHlsZXModGhpcy5oYW5kbGVEaXJlY3Rpb24ocG9zaXRpb24sIHRoaXMudHJhY2tNYXgpLCBzaXplKSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTdHJlYW0gdGhhdCBlbWl0cyB0aGUgJ3Njcm9sbFRvJyBwb3NpdGlvbiB3aGVuIGEgc2Nyb2xsYmFyIHRodW1iIGVsZW1lbnQgaXMgZHJhZ2dlZFxyXG4gICAqIFRoaXMgZnVuY3Rpb24gaXMgY2FsbGVkIGJ5IHRodW1iIGRyYWcgZXZlbnQgdXNpbmcgdmlld3BvcnQgb3Igc2Nyb2xsYmFyIHBvaW50ZXIgZXZlbnRzXHJcbiAgICovXHJcbiAgZHJhZ2dlZChldmVudDogYW55KTogT2JzZXJ2YWJsZTxudW1iZXI+IHtcclxuICAgIGxldCB0cmFja01heFN0YXJ0OiBudW1iZXI7XHJcbiAgICBsZXQgc2Nyb2xsTWF4U3RhcnQ6IG51bWJlcjtcclxuXHJcbiAgICBjb25zdCBkcmFnU3RhcnQgPSBvZihldmVudCkucGlwZShcclxuICAgICAgcHJldmVudFNlbGVjdGlvbih0aGlzLmRvY3VtZW50KSxcclxuICAgICAgdGFwKCgpID0+IHtcclxuICAgICAgICAvLyBDYXB0dXJlIHNjcm9sbE1heCBhbmQgdHJhY2tNYXggb25jZVxyXG4gICAgICAgIHRyYWNrTWF4U3RhcnQgPSB0aGlzLnRyYWNrTWF4O1xyXG4gICAgICAgIHNjcm9sbE1heFN0YXJ0ID0gdGhpcy52aWV3cG9ydFNjcm9sbE1heDtcclxuICAgICAgICB0aGlzLnNldERyYWdnaW5nKHRydWUpO1xyXG4gICAgICB9KSxcclxuICAgICk7XHJcblxyXG4gICAgY29uc3QgZHJhZ2dpbmcgPSBmcm9tRXZlbnQodGhpcy5kb2N1bWVudCwgJ21vdXNlbW92ZScsIHsgY2FwdHVyZTogdHJ1ZSwgcGFzc2l2ZTogdHJ1ZSB9KS5waXBlKHN0b3BQcm9wYWdhdGlvbigpKTtcclxuXHJcbiAgICBjb25zdCBkcmFnRW5kID0gZnJvbUV2ZW50KHRoaXMuZG9jdW1lbnQsICdtb3VzZXVwJywgeyBjYXB0dXJlOiB0cnVlIH0pLnBpcGUoXHJcbiAgICAgIHN0b3BQcm9wYWdhdGlvbigpLFxyXG4gICAgICBlbmFibGVTZWxlY3Rpb24odGhpcy5kb2N1bWVudCksXHJcbiAgICAgIHRhcCgoKSA9PiB0aGlzLnNldERyYWdnaW5nKGZhbHNlKSlcclxuICAgICk7XHJcblxyXG4gICAgcmV0dXJuIGRyYWdTdGFydC5waXBlKFxyXG4gICAgICBwbHVjayh0aGlzLnBhZ2VQcm9wZXJ0eSksXHJcbiAgICAgIG1hcCgocGFnZU9mZnNldDogbnVtYmVyKSA9PiBwYWdlT2Zmc2V0IC0gdGhpcy5kcmFnU3RhcnRPZmZzZXQpLFxyXG4gICAgICBtZXJnZU1hcCgobW91c2VEb3duT2Zmc2V0OiBudW1iZXIpID0+IGRyYWdnaW5nLnBpcGUoXHJcbiAgICAgICAgcGx1Y2sodGhpcy5jbGllbnRQcm9wZXJ0eSksXHJcbiAgICAgICAgLy8gQ2FsY3VsYXRlIGhvdyBmYXIgdGhlIHBvaW50ZXIgaXMgZnJvbSB0aGUgdG9wL2xlZnQgb2YgdGhlIHNjcm9sbGJhciAobWludXMgdGhlIGRyYWdPZmZzZXQpLlxyXG4gICAgICAgIG1hcCgobW91c2VPZmZzZXQ6IG51bWJlcikgPT4gbW91c2VPZmZzZXQgLSB0aGlzLnRyYWNrLm9mZnNldCksXHJcbiAgICAgICAgbWFwKChvZmZzZXQ6IG51bWJlcikgPT4gc2Nyb2xsTWF4U3RhcnQgKiAob2Zmc2V0IC0gbW91c2VEb3duT2Zmc2V0KSAvIHRyYWNrTWF4U3RhcnQpLFxyXG4gICAgICAgIG1hcCgocG9zaXRpb246IG51bWJlcikgPT4gdGhpcy5oYW5kbGVEcmFnKHBvc2l0aW9uLCBzY3JvbGxNYXhTdGFydCkpLFxyXG4gICAgICAgIHRhcCgocG9zaXRpb246IG51bWJlcikgPT4gdGhpcy5zY3JvbGxUbyhwb3NpdGlvbikpLFxyXG4gICAgICAgIHRha2VVbnRpbChkcmFnRW5kKVxyXG4gICAgICApKVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIC8vIFNldCBkcmFnZ2luZyBzdGF0ZVxyXG4gIHByb3RlY3RlZCBhYnN0cmFjdCBzZXREcmFnZ2luZyh2YWx1ZTogYm9vbGVhbik6IHZvaWQ7XHJcblxyXG4gIC8vIFNjcm9sbCB2aWV3cG9ydCBpbnN0YW50bHlcclxuICBwcm90ZWN0ZWQgYWJzdHJhY3Qgc2Nyb2xsVG8ocG9zaXRpb246IG51bWJlcik6IHZvaWQ7XHJcblxyXG4gIC8vIFVwZGF0ZSB0aHVtYiBlbGVtZW50IHNpemUgYW5kIHBvc2l0aW9uXHJcbiAgcHJvdGVjdGVkIGFic3RyYWN0IHVwZGF0ZVN0eWxlcyhwb3NpdGlvbjogbnVtYmVyLCBzaXplOiBudW1iZXIpOiB2b2lkO1xyXG5cclxuICAvLyBIYW5kbGUgZHJhZ2dpbmcgcG9zaXRpb24gKFN1cHBvcnQgTFRSIGFuZCBSVEwgZGlyZWN0aW9ucyBmb3IgdGhlIGhvcml6b250YWwgc2Nyb2xsYmFyKVxyXG4gIHByb3RlY3RlZCBhYnN0cmFjdCBoYW5kbGVEcmFnKHBvc2l0aW9uOiBudW1iZXIsIHNjcm9sbE1heD86IG51bWJlcik6IG51bWJlcjtcclxuXHJcbiAgLy8gSGFuZGxlIHNjcm9sbGluZyBwb3NpdGlvbiAoU3VwcG9ydCBMVFIgYW5kIFJUTCBkaXJlY3Rpb25zIGZvciB0aGUgaG9yaXpvbnRhbCBzY3JvbGxiYXIpXHJcbiAgcHJvdGVjdGVkIGFic3RyYWN0IGhhbmRsZURpcmVjdGlvbihwb3NpdGlvbjogbnVtYmVyLCBzY3JvbGxNYXg/OiBudW1iZXIpOiBudW1iZXI7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBDYWxjdWxhdGUgc2Nyb2xsYmFyIHRodW1iIHNpemVcclxuICovXHJcbmZ1bmN0aW9uIGNhbGN1bGF0ZVRodW1iU2l6ZSh0cmFja1NpemU6IG51bWJlciwgY29udGVudFNpemU6IG51bWJlciwgbWluVGh1bWJTaXplOiBudW1iZXIpOiBudW1iZXIge1xyXG4gIGNvbnN0IHNjcm9sbGJhclJhdGlvID0gdHJhY2tTaXplIC8gY29udGVudFNpemU7XHJcbiAgY29uc3QgdGh1bWJTaXplID0gc2Nyb2xsYmFyUmF0aW8gKiB0cmFja1NpemU7XHJcbiAgcmV0dXJuIE1hdGgubWF4KH5+dGh1bWJTaXplLCBtaW5UaHVtYlNpemUpO1xyXG59XHJcblxyXG4vKipcclxuICogQ2FsY3VsYXRlIHNjcm9sbGJhciB0aHVtYiBwb3NpdGlvblxyXG4gKi9cclxuZnVuY3Rpb24gY2FsY3VsYXRlVGh1bWJQb3NpdGlvbihzY3JvbGxQb3NpdGlvbjogbnVtYmVyLCBzY3JvbGxNYXg6IG51bWJlciwgdHJhY2tNYXg6IG51bWJlcik6IG51bWJlciB7XHJcbiAgcmV0dXJuIHNjcm9sbFBvc2l0aW9uICogdHJhY2tNYXggLyBzY3JvbGxNYXg7XHJcbn1cclxuIl19